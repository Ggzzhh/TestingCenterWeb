{% extends 'base.html' %}
{% import 'auth/_models.html' as model %}
{% block head %}
	{{ super() }}
	<link rel="stylesheet"
		  href="{{ url_for('static', filename='css/user.css') }}"
		  type="text/css">
	<style>
		.user {
			overflow: hidden;
			min-height: 700px;
		}
		.left-nav{
			position: relative;
			width: 30%;
			padding-right: 10px;
			padding-left: 10px;
			float: left;
			margin-top: 30px;
		}
		.right-content {
			margin-top: 30px;
			width: 70%;
			float: right;
		}

		/*胶囊式导航的css*/
		.nav-pills>li.active>a,
		.nav-pills>li.active>a:focus,
		.nav-pills>li.active>a:hover {
			color: #0f0f0f;
			background-color: #ff000a;
		}

		.nav-pills>li>a {
			color: #0f0f0f;
		}

		.nav-pills>li>a:hover {
			color: #0f0f0f;
			background-color: #f52f2f;
		}

		.my-team {
			padding-left: 25px;
			padding-right: 25px;
			overflow: hidden;
			text-align: left;
		}
		.my-team img{
			border: 2px solid #9c9c9c;
			border-radius: 15px;
		}

		.my-team #time{
			font-size: 0.8em;
		}

		.my-team .thumbnail{
			padding-top: 25px;
			text-align: center;
			font-size: 1.2em;
		}

		.my-team .caption b{
			color: #ff000a;
			text-shadow: 1px 1px 1px #ff000a;
		}

		.my-team a{
			text-decoration: none;
		}

		.my-team .well {
			color: #0f0f0f;
		}

		.create-team {
			margin-top: 100px;
			font-size: 1.5em;
			text-decoration: none;
			padding-bottom: 50px;
		}

		.modal .modal-body{
			font-size: 1.3em;
		}

		.user .table>tbody>tr>td {
			width: auto;
		}

		.table img {
			border: none;
		}

		@media screen and (max-width: 767px){
			.nav-pills>li{
				width: 100%;
			}
			.left-nav {
				width: 100%;
				clear: both;
				padding-bottom: 20px;
			}
			.right-content {
				width: 100%;
				clear: both;
			}
			.my-team {
				padding: 0;
				font-size: 0.8em;
			}
		}
	</style>
{% endblock %}
{% block page_content %}
	<div class="container">
		<div class="user">
			<div class="box-header">
				<h1>我的战队</h1>
			</div>
			<div class="left-nav well">
				<ul class="nav nav-pills nav-stacked" role="tablist" id="nav">
					<li role="presentation" class="active">
						<a href="#home" aria-controls="content" role="tab"
						   data-toggle="tab">战队简介</a>
					</li>
					<li role="presentation">
						{% if current_user.team %}
							<a href="#profile" aria-controls="profile"
							   role="tab" data-toggle="tab">成员资料</a>
						{% else %}
							<a href="#">成员资料</a>
						{% endif %}
					</li>
					<li role="presentation">
						{% if current_user.team %}
							<a href="#settings" aria-controls="settings"
							   role="tab" data-toggle="tab">相关操作</a>
						{% else %}
							<a href="#">相关操作</a>
						{% endif %}
					</li>
					<li role="presentation">
						{% if current_user.team %}
							<a href="#activities" aria-controls="activity"
							   role="tab" data-toggle="tab">活动列表</a>
						{% else %}
							<a href="#">活动列表</a>
						{% endif %}
					</li>
				</ul>
			</div>
			<div class="right-content">
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane active" id="home">
						{% if current_user.team %}
							<div class="my-team text-left">
								<div class="thumbnail">
									<img src="{{ current_user.team.emblem_hash }}"
										 class="img-rounded profile-thumbnail"
										 width="140" height="140"/>
									<div class="caption">
										<table class="table">
											<tr>
												<td>战队名</td>
												<td><b>{{ current_user.team.name }}</b></td>
											</tr>
											<tr>
												<td>成立时间</td>
												<td><span id="time"></span></td>
											</tr>
											<tr>
												<td>队长</td>
												<td><a href="{{ current_user.team.to_json()['captain']['auth_url'] }}">
													{{ current_user.team.to_json()['captain']['username'] }}
												</a></td>
											</tr>
											<tr>
												<td>人数</td>
												<td>
													{{ current_user.team.to_json()['count'] }}
												</td>
											</tr>
											<tr>
												<td>座右铭</td>
												<td>
													{{ current_user.team.to_json()['maxim'] }}
												</td>
											</tr>
											<tr>
												<td>战队简介</td>
												<td>
													{{ current_user.team.to_json()['about_us'] }}
												</td>
											</tr>
											{% if current_user.id == current_user.team.captain_id %}
												<tr>
													<td colspan="2">
														<button class="btn btn-info"
																data-toggle="modal"
																data-target="#UTeam">
															编辑
														</button>
													</td>
												</tr>
											{% endif %}
										</table>
									</div>
								</div>
							</div>
						{% else %}
							<div class="create-team">
								<p>独行者，你还没有战队</p>
								<a href="#" id="create-team"
								   data-toggle="modal"
								   data-target="#CTeam">
									创建战队
								</a>
								| <a href="#">加入战队</a>
							</div>
						{% endif %}
					</div>
					<div role="tabpanel" class="tab-pane" id="profile">
						<div class="my-team">
							<div class="well">
								<table class="table table-bordered
								table-hover table-striped text-center">
									<tr>
										<th class="text-center">成员</th>
										<th class="text-center">昵称</th>
										<th class="text-center">位置</th>
										<th class="text-center">简介</th>
										<th class="text-center">身份</th>
										<th class="text-center">操作</th>
									</tr>
									{% if current_user.team %}
										{% for player in current_user.team.players %}
											{{ model.show_player(player.easy_to_json(),
											current_user.team.captain_id) }}
										{% endfor %}
									{% endif %}
								</table>
							</div>
						</div>
					</div>
					<div role="tabpanel" class="tab-pane" id="settings">
						解散战队
						查看申请者（做成遮罩层, 点击后执行ajax获取数据）
					</div>
					<div role="tabpanel" class="tab-pane" id="activities">
{#						等待活动页面做好后 todo:展示已报名的活动 进入活动页面#}
					</div>
				</div>
			</div>

		</div>
	</div>

	<!-- Modal -->

	{% if current_user.team %}
		{{ model.update_team(current_user) }}
	{% else %}
		{{ model.create_team(current_user) }}
	{% endif %}

	<!-- todo: 队员的增删改查-->


{% endblock %}
{% block scripts %}
	{{ super() }}
	<script src="{{ url_for('static', filename='js/image.js') }}"></script>
	{% if current_user.team %}
		<script>
            moment.locale('zh-cn');
            var member_since = "{{ current_user.team.to_json()['member_since'] }}";
            $('#time').text(moment(member_since).format('YYYY年 MMM Do'))
		</script>
	{% endif %}

	<script>
        var screen = $(window).width();
        if (screen < 767){
            $('#nav').removeClass('nav-stacked')
        }

        $("#uploadImage").change(function () {
            if (this.files[0].size > 1024 * 1024 * 2){
                swal('信息', '图片太大了！处理一下吧！','info');
                return
            }
            upLoadImage(this.files[0], 'uploadPreview');
        });

        $('#submit').click(function () {
            $.get({
                url: "{{ url_for('api.team_exist') }}"
                + "?name=" + $('input[name="name"]').val(),
                data: "",
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    if (data.result === true){
                        swal('队名已存在','这个队名别人已经用了！', 'info');
                    }else{
                        var values = $('#form').serializeArray(),
                            json_data = {};
                        for (var e in values){
                            json_data[values[e].name] = values[e].value
                        }
                        json_data.emblem_hash = $('#uploadPreview').attr('src');
                        json_data.captain_id = {{ current_user.id }};
                        delete json_data.captain;
                        json_data = JSON.stringify(json_data);
                        console.log(json_data);
                        $.ajax({
                            type: "POST",
                            url: "{{ url_for('api.new_team') }}",
                            data: json_data,
                            dataType: 'json',
                            contentType: 'application/json',
                            success: function (data) {
                                if (data.result === 'ok'){
                                    window.location.reload()
                                }
                                else {
                                    swal('错误','创建失败！请联系单位工作人员！', 'error')
                                }
                            },
                            error: function () {
                                swal('错误','创建失败！请联系单位工作人员！', 'error')
                            }
                        });
                    }
                }
            });
        });

        $('#update').click(function (e) {
            e.preventDefault();
            var values = $('#form').serializeArray(),
                json_data = {};
            for (var e in values){
                json_data[values[e].name] = values[e].value
            }
            json_data.emblem_hash = $('#uploadPreview').attr('src');
            json_data.captain_id = {{ current_user.id }};
            delete json_data.captain;
            json_data.id = {{ current_user.team.id }};
            json_data = JSON.stringify(json_data);
            console.log(json_data);
            $.ajax({
                type: "POST",
                url: "{{ url_for('api.update_team', id=current_user.team.id)}}",
                data: json_data,
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    if (data.result === 'ok'){
                        swal({
                            title: '修改成功!',
                            type: 'success',
                            text: '2秒后自动跳转',
                            timer: 2000,
                            showConfirmButton: false
                        }).catch(function () {
                            window.location.reload()
                        });

                    }
                    else {
                        swal('错误','创建失败！请联系单位工作人员！', 'error')
                    }
                },
                error: function () {
                    swal('错误','创建失败！请联系单位工作人员！', 'error')
                }
            });
        })
	</script>
{% endblock %}